name: 🔐 Comprehensive Security Scan

on:
  push:
    branches: [ master, staging, development, 'feature/*' ]
  pull_request:
    branches: [ master, staging, development ]
  schedule:
    # Run daily security scan at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  security-audit:
    name: 🔍 Security Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 🏷️ Generate Build Info
      id: build-info
      run: |
        echo "sha-short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "build-date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

    # Secret Scanning
    - name: 🔐 TruffleHog Secret Scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

    - name: 🔍 GitLeaks Secret Detection
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

    # SAST - Static Application Security Testing
    - name: 🛡️ CodeQL Analysis - Initialize
      uses: github/codeql-action/init@v3
      with:
        languages: javascript, python
        config-file: ./.github/codeql/codeql-config.yml
        queries: security-extended

    # Manual build steps for interpreted languages (no autobuild needed)
    - name: 🏗️ Install Node.js Dependencies
      if: always()
      working-directory: projects/frontend/react-app
      run: |
        if [ -f "package.json" ]; then
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi
        fi

    - name: 🏗️ Install Python Dependencies
      if: always()
      run: |
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        fi
        if [ -f "projects/backend/python-api/requirements.txt" ]; then
          pip install -r projects/backend/python-api/requirements.txt
        fi

    - name: 📊 Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:javascript,python"

    - name: 🔍 Semgrep SAST Scan
      run: |
        python -m pip install semgrep
        semgrep --config=auto --sarif --output=semgrep.sarif .
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_TOKEN }}
      continue-on-error: true

    - name: 📈 Upload Semgrep SARIF
      uses: github/codeql-action/upload-sarif@v3
      if: always() && hashFiles('semgrep.sarif') != ''
      with:
        sarif_file: semgrep.sarif

    # SCA - Software Composition Analysis
    - name: 🏗️ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ☕ Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: 🔍 Snyk Security Scan
      uses: snyk/actions/setup@master
    
    - name: 🔍 Snyk Test
      run: |
        # Test for vulnerabilities
        snyk test --all-projects --severity-threshold=medium || true
        
        # Test Docker images if they exist
        if [ -f "Dockerfile" ]; then
          snyk container test --file=Dockerfile --severity-threshold=high || true
        fi
        
        # Monitor for ongoing vulnerability management
        snyk monitor --all-projects || true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    - name: 🔍 OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'devsecops-portfolio'
        path: '.'
        format: 'ALL'
        args: >
          --enableRetired
          --enableExperimental

    - name: 📤 Upload Dependency Check Results
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-report
        path: reports/

    # Container Security
    - name: 🐳 Build Test Image
      if: hashFiles('**/Dockerfile') != ''
      run: |
        docker build -t test-image:${{ steps.build-info.outputs.sha-short }} .

    - name: 🔍 Trivy Container Scan
      if: hashFiles('**/Dockerfile') != ''
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'test-image:${{ steps.build-info.outputs.sha-short }}'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: 📤 Upload Trivy SARIF
      if: always() && hashFiles('trivy-results.sarif') != ''
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'

    # Infrastructure Security
    - name: 🏗️ Setup Terraform
      if: hashFiles('**/*.tf') != ''
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.6.0'

    - name: 🔍 Checkov IaC Scan
      if: hashFiles('**/*.tf', '**/*.yml', '**/*.yaml') != ''
      uses: bridgecrewio/checkov-action@master
      with:
        directory: .
        framework: terraform,kubernetes,dockerfile,secrets
        output_format: sarif
        output_file_path: checkov-results.sarif

    - name: 📤 Upload Checkov SARIF
      if: always() && hashFiles('checkov-results.sarif') != ''
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: checkov-results.sarif

    - name: 🔍 TFSec Terraform Security Scan
      if: hashFiles('**/*.tf') != ''
      uses: aquasecurity/tfsec-action@v1.0.3
      with:
        format: sarif
        soft_fail: true

    - name: 📤 Upload TFSec SARIF
      if: always() && hashFiles('results.sarif') != ''
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: results.sarif

    # License Compliance (Optional - requires FOSSA_API_KEY secret)
    - name: 📜 FOSSA License Scan (Disabled)
      if: false  # Disabled - uncomment and configure FOSSA_API_KEY secret if needed
      run: |
        echo "FOSSA License Scan disabled - requires FOSSA_API_KEY secret configuration"

    # Security Summary Report
    - name: 📊 Generate Security Report
      if: always()
      run: |
        echo "# 🔐 Security Scan Summary" > security-report.md
        echo "**Scan Date:** $(date)" >> security-report.md
        echo "**Commit:** ${{ steps.build-info.outputs.sha-short }}" >> security-report.md
        echo "" >> security-report.md
        
        echo "## 🛡️ Scan Results" >> security-report.md
        echo "- ✅ Secret Scanning: Completed" >> security-report.md
        echo "- ✅ SAST Analysis: Completed" >> security-report.md
        echo "- ✅ Dependency Scanning: Completed" >> security-report.md
        
        if [ -f "Dockerfile" ]; then
          echo "- ✅ Container Scanning: Completed" >> security-report.md
        fi
        
        if ls *.tf >/dev/null 2>&1; then
          echo "- ✅ Infrastructure Scanning: Completed" >> security-report.md
        fi
        
        echo "" >> security-report.md
        echo "View detailed results in the Security tab of this repository." >> security-report.md

    - name: 📤 Upload Security Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.md

    # Notify on Security Issues
    - name: 🚨 Security Alert
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: '🚨 Security scan failed for ${{ github.repository }}. Please check the results immediately.'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}